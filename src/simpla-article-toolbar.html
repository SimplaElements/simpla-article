<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../simpla-styles/simpla-styles.html">
<link rel="import" href="../iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../iron-icon/iron-icon.html" async>

<!-- Material icons cherry picked from iron-icons -->
<iron-iconset-svg name="simpla-article-toolbar">
  <svg>
    <defs>
      <g id="format-bold"><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/></g>
      <g id="format-italic"><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/></g>
      <g id="format-quote"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/></g>
      <g id="format-size"><path d="M9 4v3h5v12h3V7h5V4H9zm-6 8h3v7h3v-7h3V9H3v3z"/></g>
      <g id="insert-link"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></g>
      <g id="insert-photo"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></g>
    </defs>
  </svg>
</iron-iconset-svg>

<dom-module id="simpla-article-toolbar">
  <template>
    <style>
      .toolbar {
        display: none;
      }

      .toolbar[visible] {
        display: block;
      }
    </style>

    <!--
      Range formatting toolbar
     -->
    <div class="toolbar range"
      data-name="range"
      visible$="[[_isContext('range', context)]]"
    >
    POSITION ME OVER SELECTED RANGE
    </div>

    <!--
      Newline embed controls
    -->
    <div class="toolbar newline"
      data-name="newLine"
      visible$="[[_isContext('newLine', context)]]"
    >
    POSITION ME LEFT OF NEWLINE
    </div>

    <!--
      Image controls
     -->
    <div class="toolbar image"
      data-name="image"
      visible$="[[_isContext('image', context)]]"
    >
    POSITION ME OVER FOCUSSED IMAGE
    </div>

  </template>
  <script>
    import Anchor from './behaviors/anchor';

    const TOOLBAR_CONFIGS = {
      'newLine': { placement: 'left' },
      'image': { placement: 'top' },
      'range': { placement: 'top '}
    };

    Polymer({
      is: 'simpla-article-toolbar',

      properties: {

        /**
         * Determines what toolbar UI to show
         * @type {String} range | newLine | image
         */
        context: {
          type: String,
          value: ''
        },

        /**
         * Editor instance to attach toolbar to
         * @type {Object}
         */
        editor: {
          type: Object,
          observer: '_updateEditorBindings'
        },

        /**
         * Current bounds the toolbar should follow
         * @type {Object}
         */
        bounds: Object

      },

      behaviors: [ Anchor ],

      attached() {
        Polymer.dom(this.root)
          .querySelectorAll('.toolbar')
          .forEach(toolbar => {
            this.anchor(toolbar, TOOLBAR_CONFIGS[toolbar.dataset.name]);
          });
      },

      _updateEditorBindings(editor, oldEditor) {
        this.__updatePositions = this.__updatePositions || (({ bounds } = {}) => {
          this.bounds = bounds;
        });

        this.__updateContext = this.__updateContext || (() => {
          let { selection, plugins: { image } } = editor;

          if (image.applied) {
            this.context = 'image';
          } else if (image.applicable) {
            this.context = 'newLine';
          } else if (selection) {
            this.context = 'range';
          } else {
            this.context = null;
          }
        });

        if (editor) {
          editor.on('select', this.__updatePositions);
          editor.on('plugin', this.__updateContext);

          this.__updatePositions();
          this.__updateContext();
        }

        if (oldEditor) {
          editor.off('select', this.__updatePositions);
          editor.off('plugin', this.__updateContext);
        }
      },

      /**
       * Check given check is equal to given context
       * @param  {String}  check   Potential context to check
       * @param  {String}  context Current context
       * @return {Boolean}         True if check === context
       */
      _isContext(check, context) {
        return check === context;
      }
    });
  </script>
</dom-module>
